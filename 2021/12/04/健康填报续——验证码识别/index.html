<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    健康填报续——验证码识别 |
    
    GeniusGrass&#39;s Blog
  </title>
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-健康填报续——验证码识别" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  健康填报续——验证码识别
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2021/12/04/%E5%81%A5%E5%BA%B7%E5%A1%AB%E6%8A%A5%E7%BB%AD%E2%80%94%E2%80%94%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/" class="article-date">
  <time datetime="2021-12-04T05:27:19.000Z" itemprop="datePublished">2021-12-04</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <p>12月2日，校方对校园VPN登录新增加验证码选项，导致前文<a href="https://www.zzforgood.top/2021/10/26/%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E8%87%AA%E5%8A%A8%E5%81%A5%E5%BA%B7%E5%A1%AB%E6%8A%A5%E8%84%9A%E6%9C%AC/">模拟登录</a>无法使用，因此在本文中对验证码进行突破，同时更换了selenium使用的浏览器，用edge的headless模式重新实现。（仅供学习使用，勿用于破坏网络环境）</p>
<span id="more"></span>
<p>参考博文：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41982466/article/details/109602222">Python—-截取图片指定部分</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/t8116189520/article/details/80271804">python 图片二值化处理（处理后为纯黑白的图片）</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lixuelong/p/14451608.html">Python + Selenium + Microsoft Edge浏览器运行环境搭建及配置无界面模式</a></p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p><strong>简单观察问题</strong> 首先观察验证码形式（如下图），多次刷新页面可以发现，其验证码有如下特征：</p>
<ol>
<li>仅由4位数字组成，且数字位置固定</li>
<li>无指定路径，属于动态生成文件</li>
<li>生成验证码时同时加入了随机噪声</li>
</ol>
<p><img src="/2021/12/04/健康填报续——验证码识别\login.png" alt="验证码"></p>
<p>由以上特点即可构建识别框架。对于单一的验证码图片，我们可以将其分为4个单独数字的图片，而这4个图片是需要同等对待的。因此我们可以通过编写识别单个数字图片的方法，从而实现对整张验证码识别。对单个数字图片的识别，可以通过其与标准的单个数字图片（已标注真实数字）比较，相同或相似度最高的即可认为是同一数字的图片。而对随机噪声和数字颜色随机的问题，我们可以通过将图片转为灰度后进行二值化处理，从而得到仅有黑白的二值化图片，从而消除噪声和颜色的影响。</p>
<h2 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h2><p>由以上分析构建识别框架，首先对验证码图片进行分析，<strong>直接通过右键另存验证码图片到本地</strong>，可以发现其大小为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex" xmlns="http://www.w3.org/2000/svg" width="7.291ex" height="1.557ex" role="img" focusable="false" viewbox="0 -666 3222.4 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"/></g><g data-mml-node="mn" transform="translate(2222.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/></g></g></g></svg></mjx-container>像素，直接对其进行灰度处理，观察整个验证码图片的数字位置排布。本文使用Photoshop中的参考线辅助确定数字像素排布，切分标注如下图所示（纵向数字表示该点到左边界的距离，横向数字表示该点到上边界的距离）。</p>
<p><img src="/2021/12/04/健康填报续——验证码识别\analysis_num.png" alt="数字位置分析"></p>
<p>对图像二值化处理后（二值化处理前观察，防止二值化损失图片精度影响观察结果），由上图可以将单个的数字从原图中截取出来，其后对单个数字进行观察（如下图）。</p>
<p><img src="/2021/12/04/健康填报续——验证码识别\2.svg" alt></p>
<p>可知，如果二值化处理不损失精度，其表示的数字一致时，切分出的图片应完全相同。然而，很难取定恒定的阈值使二值化处理对任意一张验证码图片不损失精度，因此在不考虑变阈值情况下，只能定义软相同概念来确定单个数字图片所表示的数字。例：如下图所示，其中的两个9因为颜色导致的灰度值差异，使得其在二值化处理后损失了部分像素，从而无法完全相同。所以我们定义度量<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex" xmlns="http://www.w3.org/2000/svg" width="1.244ex" height="2.059ex" role="img" focusable="false" viewbox="0 -705 550 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g></g></g></svg></mjx-container>，计算两图像间的差异程度，差异程度足够小时，我们就可以认为二者是相同的。</p>
<p><img src="/2021/12/04/健康填报续——验证码识别\9439.svg" alt></p>
<p>综上，就构建出了单个数字图片的数字识别，进一步即可构建整个识别框架。</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>导入相关包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br></pre></td></tr></table></figure>
<p>经过上述分析，我们应该使用保存在本地的图片进行下一步处理，但是考虑到应用场景，验证码图片要求能够自动被下载到本地，同时该验证码的性质2决定其无法被正常下载，所以我们需要以截图代替下载的图片。读入截图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img = Image.<span class="built_in">open</span>(<span class="string">r"captcha.jpg"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2021/12/04/健康填报续——验证码识别\captcha.png" alt></p>
<p>然而，其截图所得图像是经过拉伸变换的（如上图），因此我们在识别之前需要将图像调整会原本的尺寸（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex" xmlns="http://www.w3.org/2000/svg" width="7.291ex" height="1.557ex" role="img" focusable="false" viewbox="0 -666 3222.4 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/></g><g data-mml-node="mo" transform="translate(1222.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"/></g><g data-mml-node="mn" transform="translate(2222.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/></g></g></g></svg></mjx-container>），然后处理为灰度图像。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">out = img.resize((<span class="number">60</span>,<span class="number">20</span>), Image.ANTIALIAS)</span><br><span class="line"></span><br><span class="line">img_wb = out.convert(<span class="string">'L'</span>)</span><br></pre></td></tr></table></figure>
<p>设定灰度小于125的像素点为黑，即0，大于等于125的为白，即1，对灰度图像进行二值化处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">threshold = <span class="number">125</span></span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; threshold:</span><br><span class="line">        table.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.append(<span class="number">1</span>)</span><br><span class="line">photo = img_wb.point(table, <span class="string">'1'</span>)</span><br></pre></td></tr></table></figure>
<p>对二值化后的图像进行按区域划分为4个等大的单数字图像，这里用到了前文分析中的每个数字位置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">num = []</span><br><span class="line">boxes = [(<span class="number">5</span>,<span class="number">1</span>,<span class="number">17</span>,<span class="number">18</span>), (<span class="number">18</span>,<span class="number">1</span>,<span class="number">30</span>,<span class="number">18</span>), (<span class="number">31</span>,<span class="number">1</span>,<span class="number">43</span>,<span class="number">18</span>), (<span class="number">44</span>,<span class="number">1</span>,<span class="number">56</span>,<span class="number">18</span>)]</span><br><span class="line"><span class="keyword">for</span> i,box <span class="keyword">in</span> <span class="built_in">enumerate</span>(boxes):</span><br><span class="line">    num.append(photo.crop(box))</span><br></pre></td></tr></table></figure>
<p>以上是图片预处理过程，其后，先定义对两个图像差异度量方法，以简单考虑，直接对两图像矩阵做差后的矩阵取F范数，即</p>
<script type="math/tex; mode=display">Difference = || A_1 - A_2 ||_F</script><p>也就是平方和误差最小化思想，从而可定义差异计算函数。（注：这里以np.array作为图像参数）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_squre_error</span>(<span class="params">num1, num2</span>):</span></span><br><span class="line">    <span class="keyword">return</span> np.<span class="built_in">sum</span>(np.square(num1 - num2))</span><br></pre></td></tr></table></figure>
<p>由以上函数，即可定义判别函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identify</span>(<span class="params">num, STAND_NUM</span>):</span></span><br><span class="line">    errors = [img_squre_error(num, NUM) <span class="keyword">for</span> NUM <span class="keyword">in</span> STAND_NUM]</span><br><span class="line">    <span class="keyword">return</span> np.argmin(errors)</span><br></pre></td></tr></table></figure>
<p>其中<code>STAND_NUM</code>是标准情况下的各数字对应图像数组。（构建该标准情况组，应截图获得包含全部数字0-9的验证码图像，并切出每个数字手动控制二值化阈值，使其过程中不损失像素且完全消除噪声，本文采用计算后本地保存、调用时加载的方式处理）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># save</span></span><br><span class="line">np.save(<span class="string">r'./stand/num'</span>, num_arr)</span><br><span class="line"><span class="comment"># load</span></span><br><span class="line">np.load(<span class="string">r'./stand/num'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># load standard number image</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_SN</span>():</span></span><br><span class="line">    url = <span class="string">r'./stand/num'</span></span><br><span class="line">    <span class="keyword">return</span> [np.load(url + <span class="built_in">str</span>(i) + <span class="string">'.npy'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line">STAND_NUM = init_SN()</span><br></pre></td></tr></table></figure>
<p>由以上判别函数可以定义方法——对一个由4个单数字图像组成的列表，将其中每个数字进行判别后输出对应代表数字的列表。（注：在将图像传入上文方法中之前，先将图片数据转化为np.array，并取图像反值，即黑为1白为0）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identify_nums</span>(<span class="params">nums, STAND_NUM=STAND_NUM</span>):</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">        temp = np.copy(num)</span><br><span class="line">        inv_temp = np.ones(temp.shape) - temp.astype(<span class="string">'int'</span>)</span><br><span class="line">        result.append(identify(inv_temp, STAND_NUM))</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>综上，即完成了全部识别过程。整理后可编写为方法文件，在原模拟登录过程中直接调用，即可实现对验证码的突破。</p>
<h2 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h2><p>首先构建方法文件<code>captcha.py</code>，其中根据效果将二值化阈值调整为140，目前测试精度为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex" xmlns="http://www.w3.org/2000/svg" width="3.394ex" height="1.557ex" role="img" focusable="false" viewbox="0 -666 1500 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/></g></g></g></svg></mjx-container>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_SN</span>():</span></span><br><span class="line">    url = <span class="string">r'./stand/num'</span></span><br><span class="line">    <span class="keyword">return</span> [np.load(url + <span class="built_in">str</span>(i) + <span class="string">'.npy'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line">STAND_NUM = init_SN()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_table</span>(<span class="params">threshold=<span class="number">125</span></span>):</span></span><br><span class="line">    <span class="string">"""initial a table for the method Image.point(table, *args).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        threshold (int, optional): if the pixel's grayscale less than threshold,</span></span><br><span class="line"><span class="string">        it will be set as 0 else 1. Defaults to 125.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list: a table array, such as [0,0,0,...,1,1,1] (length 256)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    table = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">if</span> i &lt; threshold:</span><br><span class="line">            table.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            table.append(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> table</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_nums</span>(<span class="params">photo</span>):</span></span><br><span class="line">    <span class="string">"""slice the image has 4 numbers into 4 one number images.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        photo (Image): the photo after binarization is composed of 0 and 1.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list: a list of 4 one number images</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    num = []</span><br><span class="line">    boxes = [(<span class="number">5</span>,<span class="number">1</span>,<span class="number">17</span>,<span class="number">18</span>), (<span class="number">18</span>,<span class="number">1</span>,<span class="number">30</span>,<span class="number">18</span>), (<span class="number">31</span>,<span class="number">1</span>,<span class="number">43</span>,<span class="number">18</span>), (<span class="number">44</span>,<span class="number">1</span>,<span class="number">56</span>,<span class="number">18</span>)]</span><br><span class="line">    <span class="keyword">for</span> box <span class="keyword">in</span> boxes:</span><br><span class="line">        num.append(photo.crop(box))</span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_squre_error</span>(<span class="params">num1, num2</span>):</span></span><br><span class="line">    <span class="string">"""calculate the difference of two number images</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        num1 (ndarray): number image1</span></span><br><span class="line"><span class="string">        num2 (ndarray): number image2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        int: difference of two number images</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> np.<span class="built_in">sum</span>(np.square(num1 - num2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identify</span>(<span class="params">num, STAND_NUM</span>):</span></span><br><span class="line">    <span class="string">"""identify the number which is in a number image by comparing the image </span></span><br><span class="line"><span class="string">    with standard number images.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        num (ndarray): number image</span></span><br><span class="line"><span class="string">        STAND_NUM (list): standard number images</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        int: maximum likelihood number</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    errors = [img_squre_error(num, NUM) <span class="keyword">for</span> NUM <span class="keyword">in</span> STAND_NUM]</span><br><span class="line">    <span class="keyword">return</span> np.argmin(errors)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identify_nums</span>(<span class="params">nums, STAND_NUM=STAND_NUM</span>):</span></span><br><span class="line">    <span class="string">"""identify a 4 number image by calling method identify(num, STAND_NUM)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        nums (Image): a 4 number image</span></span><br><span class="line"><span class="string">        STAND_NUM (list, optional): standard number images. Defaults to STAND_NUM.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list: identify reuslt (4 numbers)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">        temp = np.copy(num)</span><br><span class="line">        inv_temp = np.ones(temp.shape) - temp.astype(<span class="string">'int'</span>)</span><br><span class="line">        result.append(identify(inv_temp, STAND_NUM))</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">identify_test_img</span>(<span class="params">img_file=<span class="string">'test.png'</span></span>):</span></span><br><span class="line">    <span class="string">"""identify a image file by reading a image and calling identify_nums()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img_file (str, optional): image file path. Defaults to 'test.jpg'.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        list: identify result</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    test_img = Image.<span class="built_in">open</span>(img_file)</span><br><span class="line">    out_img = test_img.resize((<span class="number">60</span>,<span class="number">20</span>), Image.ANTIALIAS)</span><br><span class="line">    img_wb = out_img.convert(<span class="string">'L'</span>)</span><br><span class="line">    table = init_table(<span class="number">140</span>)</span><br><span class="line">    photo = img_wb.point(table, <span class="string">'1'</span>)</span><br><span class="line">    nums = get_nums(photo)</span><br><span class="line">    result = identify_nums(nums)</span><br><span class="line">    numstr = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> result:</span><br><span class="line">        numstr += <span class="built_in">str</span>(num)</span><br><span class="line">    <span class="keyword">return</span> numstr</span><br></pre></td></tr></table></figure>
<p>模拟登录部分（仅展示登录，后续操作与前文相同）（已更换webdriver使用的浏览器为Edge）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> captcha <span class="keyword">import</span> identify_test_img</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> msedge.selenium_tools <span class="keyword">import</span> EdgeOptions</span><br><span class="line"><span class="keyword">from</span> msedge.selenium_tools <span class="keyword">import</span> Edge</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">username_str = <span class="string">'学号'</span></span><br><span class="line">password_str = <span class="string">'密码'</span></span><br><span class="line"></span><br><span class="line">edgedriver_dir = <span class="string">r'msedgedriver.exe所在路径'</span></span><br><span class="line"></span><br><span class="line">edge_options = EdgeOptions()</span><br><span class="line">edge_options.use_chromium = <span class="literal">True</span></span><br><span class="line">edge_options.add_argument(<span class="string">'headless'</span>)</span><br><span class="line">browser = Edge(executable_path=edgedriver_dir,options=edge_options)</span><br><span class="line"></span><br><span class="line">url = <span class="string">r'https://workflow.sues.edu.cn/default/work/shgcd/jkxxcj/jkxxcj.jsp'</span></span><br><span class="line"></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.implicitly_wait(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">username = browser.find_element_by_name(<span class="string">'username'</span>)</span><br><span class="line">username.send_keys(username_str)</span><br><span class="line"></span><br><span class="line">password = browser.find_element_by_name(<span class="string">'password'</span>)</span><br><span class="line">password.send_keys(password_str)</span><br><span class="line"></span><br><span class="line">img = browser.find_element_by_xpath(<span class="string">'//form/div/img'</span>)</span><br><span class="line"><span class="comment"># 保存验证码截图在本地当前路径下</span></span><br><span class="line">img.screenshot(<span class="string">'test.png'</span>)</span><br><span class="line"><span class="comment"># 默认读取图像文件'test.png'</span></span><br><span class="line">result = identify_test_img()</span><br><span class="line"><span class="comment"># 填写验证码</span></span><br><span class="line">captcha = browser.find_element_by_id(<span class="string">'authcode'</span>)</span><br><span class="line">captcha.send_keys(result)</span><br><span class="line"></span><br><span class="line">login_button = browser.find_element_by_name(<span class="string">'submit'</span>)</span><br><span class="line">login_button.click()</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文对前文代码进行了小幅完善和改进，同时应对已经变化的登录环境进行了更新，增加突破简单验证码功能，计算相对简单，且暂时未见无法识别或识别错误的情况出现。对该简单验证码，以上方法是作者权衡再三选定的，若数字位置有变化，或加入其他因素进行影响，有计划使用监督学习的方法进行解决，当然，本问题也可用监督学习解决，但监督学习需要对大量样本进行标注，且难以在能达到如此高的精度的同时保证计算快速。如果读者有所见解，可以在评论区中留言交流。如有需要，可以联系提供标准数字组以供学习。</p>
<p><em>本文仅做技术讨论，如使用该技术造成危害概不负责。</em></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.zzforgood.top/2021/12/04/%E5%81%A5%E5%BA%B7%E5%A1%AB%E6%8A%A5%E7%BB%AD%E2%80%94%E2%80%94%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/" data-id="ckwrixi660018n4oj4u0t26ut" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2021/12/13/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84%E8%87%AA%E9%80%82%E5%BA%94%E5%9B%BE%E7%89%87%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0%E8%84%9A%E6%9C%AC/" class="article-nav-link">
    <strong class="article-nav-caption">Newer</strong>
    <div class="article-nav-title">
      
      从0开始的自适应图片添加水印脚本
      
    </div>
  </a>
  
  
  <a href="/2021/11/12/%E6%96%87%E7%8C%AE%E7%AE%A1%E7%90%86%E6%8C%87%E5%8C%97/" class="article-nav-link">
    <strong class="article-nav-caption">Older</strong>
    <div class="article-nav-title">文献管理指北</div>
  </a>
  
</nav>

  

  
  
  
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">


<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>


<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'b9cfa880780f6dc246f0',
    clientSecret: 'eece6422d853f25460f68edcaa0506ce9f0b30a8',
    repo: 'lyzsj114.github.io',
    owner: 'lyzsj114',
    admin: ['lyzsj114'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>

  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>GeniusGrass&#39;s Blog &copy; 2021</li>
      
        <li>GENIUSGRASS</li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="GeniusGrass&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>





<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>